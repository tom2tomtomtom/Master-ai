<!DOCTYPE html>
<html>
<head>
    <title>Master-AI Lessons Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; background: white; border-radius: 3px; }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        pre { background: #eee; padding: 10px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîç Master-AI Lessons Debug Tool</h1>
    <p>This will help diagnose why lessons aren't showing up in your browser.</p>
    
    <div class="debug-section">
        <h3>Step 1: Basic Connectivity</h3>
        <button onclick="testBasicConnectivity()">Test Site Access</button>
        <div id="connectivity-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>Step 2: API Access</h3>
        <button onclick="testAPI()">Test Lessons API</button>
        <div id="api-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>Step 3: Authentication Status</h3>
        <button onclick="checkAuthStatus()">Check Auth</button>
        <div id="auth-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>Step 4: Page Content Analysis</h3>
        <button onclick="analyzeLessonsPage()">Analyze Lessons Page</button>
        <div id="content-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>Step 5: JavaScript Console Errors</h3>
        <button onclick="checkConsoleErrors()">Check Console</button>
        <div id="console-result" class="result"></div>
        <p><em>Also press F12 and check the Console tab for errors</em></p>
    </div>

    <script>
        let errors = [];
        
        // Capture console errors
        window.addEventListener('error', function(e) {
            errors.push(`JS Error: ${e.message} at ${e.filename}:${e.lineno}`);
        });

        async function testBasicConnectivity() {
            const result = document.getElementById('connectivity-result');
            result.innerHTML = 'Testing...';
            
            try {
                const response = await fetch('https://www.master-ai-learn.com/', { 
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                result.innerHTML = '<div class="success">‚úÖ Site is accessible</div>';
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Site access failed: ${error.message}</div>`;
            }
        }

        async function testAPI() {
            const result = document.getElementById('api-result');
            result.innerHTML = 'Testing API...';
            
            try {
                const response = await fetch('https://www.master-ai-learn.com/api/lessons?page=1&limit=3', {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const status = response.status;
                const statusText = response.statusText;
                
                if (response.ok) {
                    const data = await response.json();
                    const lessonCount = data.lessons?.length || 0;
                    const totalLessons = data.pagination?.total || 0;
                    
                    result.innerHTML = `
                        <div class="success">
                            ‚úÖ API is working!<br>
                            Status: ${status}<br>
                            Lessons returned: ${lessonCount}<br>
                            Total lessons in DB: ${totalLessons}
                        </div>
                        <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
                    `;
                } else {
                    const errorText = await response.text();
                    result.innerHTML = `
                        <div class="error">
                            ‚ùå API Error<br>
                            Status: ${status} ${statusText}<br>
                            Response: ${errorText}
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå API call failed: ${error.message}</div>`;
            }
        }

        async function checkAuthStatus() {
            const result = document.getElementById('auth-result');
            result.innerHTML = 'Checking authentication...';
            
            // Check if we're on the correct domain
            const currentDomain = window.location.hostname;
            const targetDomain = 'www.master-ai-learn.com';
            
            if (currentDomain !== targetDomain) {
                result.innerHTML = `
                    <div class="warning">
                        ‚ö†Ô∏è You're running this on ${currentDomain}<br>
                        For accurate results, open this at: https://${targetDomain}/debug-in-browser.html
                    </div>
                `;
                return;
            }
            
            // Check localStorage/sessionStorage for auth tokens
            const supabaseSession = localStorage.getItem('sb-fsohtauqtcftdjcjfdpq-auth-token');
            const hasSupabaseAuth = !!supabaseSession;
            
            // Try to access a protected endpoint
            try {
                const response = await fetch('/api/user/profile', {
                    credentials: 'include'
                });
                
                result.innerHTML = `
                    <div class="${response.ok ? 'success' : 'warning'}">
                        ${response.ok ? '‚úÖ' : '‚ö†Ô∏è'} Auth Status<br>
                        Profile API: ${response.status}<br>
                        Supabase session: ${hasSupabaseAuth ? 'Present' : 'Missing'}<br>
                        Current URL: ${window.location.href}
                    </div>
                `;
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        ‚ùå Auth check failed<br>
                        Error: ${error.message}<br>
                        Supabase session: ${hasSupabaseAuth ? 'Present' : 'Missing'}
                    </div>
                `;
            }
        }

        async function analyzeLessonsPage() {
            const result = document.getElementById('content-result');
            result.innerHTML = 'Analyzing lessons page...';
            
            try {
                // Fetch the lessons page HTML
                const response = await fetch('https://www.master-ai-learn.com/dashboard/lessons', {
                    credentials: 'include'
                });
                
                if (response.redirected) {
                    result.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è Lessons page redirected<br>
                            Original URL: /dashboard/lessons<br>
                            Redirected to: ${response.url}<br>
                            This means authentication is required
                        </div>
                    `;
                    return;
                }
                
                const html = await response.text();
                
                // Check for lesson content in HTML
                const hasLessonData = html.includes('AI Tool Selection') || html.includes('ChatGPT Email') || html.includes('Start Lesson');
                const hasLoadingState = html.includes('Loading') || html.includes('loading');
                const hasErrorState = html.includes('Error') || html.includes('error');
                
                // Count potential lesson elements
                const lessonMatches = (html.match(/Lesson \d+:/g) || []).length;
                
                result.innerHTML = `
                    <div class="${hasLessonData ? 'success' : 'error'}">
                        ${hasLessonData ? '‚úÖ' : '‚ùå'} Lesson Content Analysis<br>
                        Server has lesson data: ${hasLessonData}<br>
                        Lesson matches found: ${lessonMatches}<br>
                        Shows loading state: ${hasLoadingState}<br>
                        Shows error state: ${hasErrorState}<br>
                        Response size: ${html.length} characters
                    </div>
                    <details>
                        <summary>HTML Sample (first 1000 chars)</summary>
                        <pre>${html.substring(0, 1000)}...</pre>
                    </details>
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Failed to analyze: ${error.message}</div>`;
            }
        }

        function checkConsoleErrors() {
            const result = document.getElementById('console-result');
            
            result.innerHTML = `
                <div class="${errors.length === 0 ? 'success' : 'warning'}">
                    ${errors.length === 0 ? '‚úÖ' : '‚ö†Ô∏è'} Console Errors<br>
                    Captured errors: ${errors.length}
                </div>
                ${errors.length > 0 ? `<pre>${errors.join('\n')}</pre>` : ''}
                <p><strong>Next:</strong> Press F12 ‚Üí Console tab and look for red error messages</p>
            `;
        }

        // Auto-run basic connectivity test
        window.onload = function() {
            document.body.insertAdjacentHTML('afterbegin', `
                <div class="debug-section" style="background: #e3f2fd;">
                    <h3>üéØ Quick Instructions</h3>
                    <ol>
                        <li>Save this file as <code>debug-in-browser.html</code></li>
                        <li>Go to <a href="https://www.master-ai-learn.com/" target="_blank">https://www.master-ai-learn.com/</a></li>
                        <li>Sign in with Google if needed</li>
                        <li>Navigate to the lessons page: <a href="https://www.master-ai-learn.com/dashboard/lessons" target="_blank">/dashboard/lessons</a></li>
                        <li>Open this debug file in the same browser tab/window</li>
                        <li>Run all the tests below</li>
                    </ol>
                </div>
            `);
        };
    </script>
</body>
</html>

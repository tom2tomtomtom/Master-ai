<!DOCTYPE html>
<html>
<head>
    <title>Master-AI Lessons Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; background: white; border-radius: 3px; }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        pre { background: #eee; padding: 10px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîç Master-AI Lessons Debug Tool</h1>
    <p>Testing from the actual domain to avoid CORS issues.</p>
    
    <div class="debug-section">
        <h3>Step 1: API Access Test</h3>
        <button onclick="testAPI()">Test Lessons API</button>
        <div id="api-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>Step 2: Authentication Status</h3>
        <button onclick="checkAuth()">Check Authentication</button>
        <div id="auth-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>Step 3: Lessons Page Analysis</h3>
        <button onclick="analyzeLessonsPage()">Analyze Lessons Page</button>
        <div id="content-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>Step 4: Quick Navigation</h3>
        <a href="/dashboard/lessons" target="_blank">
            <button>Go to Lessons Page</button>
        </a>
        <a href="/dashboard" target="_blank">
            <button>Go to Dashboard</button>
        </a>
    </div>

    <script>
        async function testAPI() {
            const result = document.getElementById('api-result');
            result.innerHTML = 'Testing API...';
            
            try {
                const response = await fetch('/api/lessons?page=1&limit=5', {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const lessonCount = data.lessons?.length || 0;
                    const totalLessons = data.pagination?.total || 0;
                    
                    result.innerHTML = `
                        <div class="success">
                            ‚úÖ API is working!<br>
                            Status: ${response.status}<br>
                            Lessons returned: ${lessonCount}<br>
                            Total lessons in DB: ${totalLessons}
                        </div>
                        <details>
                            <summary>Sample lesson data</summary>
                            <pre>${JSON.stringify(data.lessons?.[0], null, 2)}</pre>
                        </details>
                    `;
                } else {
                    const errorText = await response.text();
                    result.innerHTML = `
                        <div class="error">
                            ‚ùå API Error<br>
                            Status: ${response.status}<br>
                            Response: ${errorText}
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå API call failed: ${error.message}</div>`;
            }
        }

        async function checkAuth() {
            const result = document.getElementById('auth-result');
            result.innerHTML = 'Checking authentication...';
            
            // Check for Supabase session
            const supabaseSession = localStorage.getItem('sb-fsohtauqtcftdjcjfdpq-auth-token');
            
            try {
                // Try to access dashboard
                const dashResponse = await fetch('/dashboard', {
                    credentials: 'include',
                    redirect: 'manual'
                });
                
                const isAuthenticated = dashResponse.status !== 302 && !dashResponse.url?.includes('signin');
                
                result.innerHTML = `
                    <div class="${isAuthenticated ? 'success' : 'warning'}">
                        ${isAuthenticated ? '‚úÖ' : '‚ö†Ô∏è'} Authentication Status<br>
                        Dashboard access: ${dashResponse.status}<br>
                        Supabase session: ${supabaseSession ? 'Present' : 'Missing'}<br>
                        ${!isAuthenticated ? 'You may need to sign in first' : 'Authenticated successfully'}
                    </div>
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Auth check failed: ${error.message}</div>`;
            }
        }

        async function analyzeLessonsPage() {
            const result = document.getElementById('content-result');
            result.innerHTML = 'Analyzing lessons page...';
            
            try {
                const response = await fetch('/dashboard/lessons', {
                    credentials: 'include'
                });
                
                if (response.redirected && response.url.includes('signin')) {
                    result.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è Lessons page requires authentication<br>
                            Redirected to: ${response.url}<br>
                            <a href="/auth/signin">Click here to sign in</a>
                        </div>
                    `;
                    return;
                }
                
                const html = await response.text();
                
                // Check for lesson content
                const hasLessonData = html.includes('AI Tool Selection') || 
                                     html.includes('Start Lesson') ||
                                     html.includes('Lesson 0') ||
                                     html.includes('Lesson 1');
                
                const hasLoadingState = html.includes('Loading') || html.includes('loading');
                const hasErrorState = html.includes('Error') || html.includes('No Lessons Available');
                
                // Count lesson matches
                const lessonMatches = (html.match(/Lesson \d+:/g) || []).length;
                
                result.innerHTML = `
                    <div class="${hasLessonData ? 'success' : 'error'}">
                        ${hasLessonData ? '‚úÖ' : '‚ùå'} Lessons Page Content<br>
                        Has lesson data: ${hasLessonData}<br>
                        Lesson matches: ${lessonMatches}<br>
                        Shows loading: ${hasLoadingState}<br>
                        Shows error: ${hasErrorState}<br>
                        Response size: ${html.length} chars
                    </div>
                    ${!hasLessonData ? `
                        <div class="warning">
                            üîß Possible issues:<br>
                            ‚Ä¢ Authentication required<br>
                            ‚Ä¢ Database connection problem<br>
                            ‚Ä¢ Client-side rendering issue<br>
                            <a href="/dashboard/lessons" target="_blank">Try opening lessons page</a>
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Analysis failed: ${error.message}</div>`;
            }
        }

        // Auto-run tests when page loads
        window.onload = function() {
            console.log('üîç Debug tool loaded, running initial tests...');
            setTimeout(testAPI, 500);
            setTimeout(checkAuth, 1000);
        };
    </script>
</body>
</html>
